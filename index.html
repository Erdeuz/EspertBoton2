<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Escape de Lomas - Luis Espert</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #87CEEB 0%, #E0E0E0 50%);
            font-family: 'Arial Black', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 800px;
            max-height: 600px;
            background: linear-gradient(180deg, #87CEEB 0%, #90EE90 30%, #808080 100%);
            border: 2px solid #333;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #87CEEB 0%, #90EE90 30%, #696969 100%);
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: clamp(14px, 3vw, 18px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
        }

        #mobileControls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 15;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #333;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            cursor: pointer;
            transition: all 0.1s;
        }

        .control-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.6);
        }

        #startScreen, #gameOverScreen, #winScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        button {
            padding: 12px 24px;
            font-size: clamp(16px, 4vw, 20px);
            font-weight: bold;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        button:hover, button:active {
            background: #FF8C42;
            transform: scale(1.05);
        }

        h1 {
            font-size: clamp(24px, 6vw, 36px);
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }

        .instructions {
            font-size: clamp(12px, 3vw, 16px);
            margin: 20px;
            max-width: 90%;
            line-height: 1.5;
        }

        #helicopter {
            position: absolute;
            font-size: clamp(32px, 8vw, 48px);
            z-index: 50;
            animation: fly 2s ease-in-out infinite;
        }

        @keyframes fly {
            0%, 100% { transform: translateY(0px) rotate(-2deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }

        /* Ocultar controles m√≥viles en pantallas grandes */
        @media (min-width: 768px) {
            #mobileControls {
                display: none;
            }
        }

        /* Optimizaci√≥n para pantallas muy peque√±as */
        @media (max-width: 480px) {
            #gameContainer {
                border: 1px solid #333;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #ui {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="ui">
            <div>Tiempo: <span id="timer">60</span>s</div>
            <div>Vidas: <span id="lives">5</span></div>
            <div>Puntaje: <span id="score">0</span></div>
        </div>

        <!-- Controles m√≥viles -->
        <div id="mobileControls">
            <div class="control-btn" id="leftBtn">‚Üê</div>
            <div class="control-btn" id="rightBtn">‚Üí</div>
        </div>

        <div id="startScreen">
            <h1>üèÉ‚Äç‚ôÇÔ∏è ESCAPE DE LOMAS üèçÔ∏è</h1>
            <div class="instructions">
                <p><strong>¬°Luis Espert debe escapar de Lomas en 60 segundos!</strong></p>
                <p>üèçÔ∏è Usa las flechas o toca los botones para moverte</p>
                <p>ü•¨ Esquiva las verduras de los vecinos</p>
                <p>üöÅ Si sobrevives, ¬°te espera un helic√≥ptero!</p>
                <p>üíÄ Tienes 5 vidas. ¬°No te rindas!</p>
            </div>
            <button onclick="startGame()">¬°COMENZAR ESCAPE!</button>
        </div>

        <div id="gameOverScreen" class="hidden">
            <h1>üí• ¬°ATRAPADO EN LOMAS! üí•</h1>
            <p>Las verduras te alcanzaron...</p>
            <p>Puntaje final: <span id="finalScore">0</span></p>
            <button onclick="restartGame()">Intentar de nuevo</button>
        </div>

        <div id="winScreen" class="hidden">
            <h1>üéâ ¬°ESCAPASTE DE LOMAS! üöÅ</h1>
            <p>¬°Luis Espert logr√≥ subir al helic√≥ptero!</p>
            <p>Puntaje final: <span id="winScore">0</span></p>
            <div id="helicopter">üöÅ</div>
            <button onclick="restartGame()">Jugar de nuevo</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Variables del juego
        let gameState = 'start';
        let timeLeft = 60;
        let lives = 5;
        let score = 0;
        let gameSpeed = 2;
        let gameMusic = null;
        let musicStarted = false;
        let audioContext = null;
        
        // Configurar canvas responsivo
        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            canvas.style.width = containerWidth + 'px';
            canvas.style.height = containerHeight + 'px';
            
            // Mantener proporci√≥n 4:3
            const scale = Math.min(containerWidth / 800, containerHeight / 600);
            canvas.width = 800;
            canvas.height = 600;
        }
        
        // Ajustar canvas al cargar y al cambiar tama√±o
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Posici√≥n del protagonista
        let player = {
            x: canvas.width / 2,
            y: canvas.height - 150,
            width: 50,
            height: 80,
            dx: 0
        };
        
        // Arrays para objetos del juego
        let vegetables = [];
        let roadLines = [];
        let buildings = [];
        let clouds = [];
        
        // Controles (teclado + t√°ctil)
        let keys = {};
        let mobileControls = {
            left: false,
            right: false
        };
        
        // Inicializar AudioContext
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('AudioContext no soportado:', e);
                }
            }
        }
        
        // Sistema de m√∫sica con archivo externo
        function loadGameMusic() {
            // Detener m√∫sica anterior si existe
            if (gameMusic) {
                gameMusic.pause();
                gameMusic.currentTime = 0;
                gameMusic = null;
            }
            
            // Crear nuevo elemento de audio
            gameMusic = new Audio();
            gameMusic.src = 'https://github.com/Erdeuz/EspertBoton/raw/refs/heads/main/public/Asspera.mp3';
            gameMusic.crossOrigin = 'anonymous';
            gameMusic.loop = true;
            gameMusic.volume = 0.3;
            gameMusic.preload = 'auto';
            
            // Configurar para comenzar desde el segundo 40
            gameMusic.addEventListener('loadedmetadata', () => {
                console.log('üéµ M√∫sica cargada, duraci√≥n:', gameMusic.duration, 'segundos');
                if (gameMusic.duration > 40) {
                    gameMusic.currentTime = 40;
                }
            });
            
            // Manejar errores y usar fallback
            gameMusic.addEventListener('error', (e) => {
                console.warn('‚ùå Error cargando m√∫sica externa:', e);
                console.log('üéµ Usando m√∫sica sint√©tica de respaldo...');
                playFallbackMusic();
            });
            
            // Asegurar que la m√∫sica empiece desde el segundo 40 cada vez
            gameMusic.addEventListener('play', () => {
                if (gameMusic.currentTime < 40 && gameMusic.duration > 40) {
                    gameMusic.currentTime = 40;
                }
                console.log('üéµ Reproduciendo m√∫sica desde:', gameMusic.currentTime, 'segundos');
            });
        }
        
        function playBackgroundMusic() {
            if (!gameMusic) {
                loadGameMusic();
            }
            
            if (gameMusic && gameState === 'playing') {
                // Asegurar que comience desde el segundo 40
                if (gameMusic.duration > 40) {
                    gameMusic.currentTime = 40;
                }
                
                gameMusic.play().catch(e => {
                    console.warn('‚ùå No se pudo reproducir la m√∫sica autom√°ticamente:', e);
                    console.log('üéµ Intentando con m√∫sica sint√©tica...');
                    playFallbackMusic();
                });
            }
        }
        
        function stopBackgroundMusic() {
            if (gameMusic) {
                gameMusic.pause();
                // Resetear al segundo 40 para el pr√≥ximo inicio
                if (gameMusic.duration > 40) {
                    gameMusic.currentTime = 40;
                }
            }
        }
        
        // M√∫sica sint√©tica como respaldo
        function playFallbackMusic() {
            if (!audioContext) initAudioContext();
            if (!audioContext || gameState !== 'playing') return;
            
            // Melod√≠a √©pica sint√©tica
            const melody = [261.63, 329.63, 392.00, 523.25, 659.25, 523.25, 392.00, 329.63];
            let noteIndex = 0;
            
            function playNextNote() {
                if (gameState !== 'playing') return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = melody[noteIndex % melody.length];
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.4);
                
                noteIndex++;
                
                if (gameState === 'playing') {
                    setTimeout(playNextNote, 400);
                }
            }
            
            playNextNote();
        }
        
        // Configurar controles t√°ctiles
        function setupMobileControls() {
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            
            // Funci√≥n para manejar inicio de toque/click
            function handleStart(direction) {
                mobileControls[direction] = true;
                initAudioContext(); // Inicializar audio en interacci√≥n del usuario
            }
            
            function handleEnd(direction) {
                mobileControls[direction] = false;
            }
            
            // Bot√≥n izquierdo
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleStart('left');
            });
            
            leftBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleEnd('left');
            });
            
            leftBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                handleStart('left');
            });
            
            leftBtn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                handleEnd('left');
            });
            
            // Bot√≥n derecho
            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleStart('right');
            });
            
            rightBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleEnd('right');
            });
            
            rightBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                handleStart('right');
            });
            
            rightBtn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                handleEnd('right');
            });
            
            // Evitar scroll al tocar controles
            leftBtn.addEventListener('touchmove', (e) => e.preventDefault());
            rightBtn.addEventListener('touchmove', (e) => e.preventDefault());
        }
        
        // Inicializar elementos del fondo
        function initBackground() {
            roadLines = [];
            buildings = [];
            clouds = [];
            
            // L√≠neas de carretera
            for (let i = 0; i < 15; i++) {
                roadLines.push({
                    x: canvas.width / 2 - 2,
                    y: i * 50,
                    width: 4,
                    height: 20
                });
            }
            
            // Edificios
            for (let i = 0; i < 20; i++) {
                buildings.push({
                    x: Math.random() * 180,
                    y: i * 40,
                    width: 60 + Math.random() * 40,
                    height: 40 + Math.random() * 60,
                    side: 'left',
                    color: `hsl(${Math.random() * 60 + 200}, 30%, ${Math.random() * 20 + 40}%)`
                });
                
                buildings.push({
                    x: canvas.width - 200 + Math.random() * 120,
                    y: i * 40,
                    width: 60 + Math.random() * 40,
                    height: 40 + Math.random() * 60,
                    side: 'right',
                    color: `hsl(${Math.random() * 60 + 200}, 30%, ${Math.random() * 20 + 40}%)`
                });
            }
            
            // Nubes
            for (let i = 0; i < 12; i++) {
                clouds.push({
                    x: Math.random() * canvas.width,
                    y: i * 80 - 200,
                    size: Math.random() * 30 + 20
                });
            }
        }
        
        // Dibujar el fondo
        function drawBackground() {
            // Cielo con gradiente
            let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.7, '#90EE90');
            gradient.addColorStop(1, '#696969');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Nubes
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            clouds.forEach(cloud => {
                if (cloud.y > -cloud.size && cloud.y < canvas.height + cloud.size) {
                    ctx.beginPath();
                    ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
                    ctx.arc(cloud.x + cloud.size * 0.6, cloud.y, cloud.size * 0.8, 0, Math.PI * 2);
                    ctx.arc(cloud.x - cloud.size * 0.4, cloud.y, cloud.size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Edificios
            buildings.forEach(building => {
                if (building.y > -building.height && building.y < canvas.height) {
                    ctx.fillStyle = building.color;
                    ctx.fillRect(building.x, building.y, building.width, building.height);
                    
                    // Ventanas iluminadas
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.8)';
                    for (let i = 0; i < Math.floor(building.width / 20); i++) {
                        for (let j = 0; j < Math.floor(building.height / 25); j++) {
                            if (Math.random() > 0.6) {
                                ctx.fillRect(
                                    building.x + i * 20 + 5, 
                                    building.y + j * 25 + 5, 
                                    10, 15
                                );
                            }
                        }
                    }
                }
            });
            
            // Carretera principal
            ctx.fillStyle = '#404040';
            ctx.fillRect(canvas.width / 2 - 150, 0, 300, canvas.height);
            
            // Veredas
            ctx.fillStyle = '#D3D3D3';
            ctx.fillRect(canvas.width / 2 - 170, 0, 20, canvas.height);
            ctx.fillRect(canvas.width / 2 + 150, 0, 20, canvas.height);
            
            // L√≠neas de carretera
            ctx.fillStyle = 'white';
            roadLines.forEach(line => {
                ctx.fillRect(line.x, line.y, line.width, line.height);
            });
        }
        
        // Dibujar al protagonista (Luis Espert en moto)
        function drawPlayer() {
            ctx.save();
            
            // Sombra
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(player.x - 25, player.y + 70, 50, 10);
            
            // Moto - parte trasera
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(player.x - 20, player.y + 25, 40, 35);
            
            // Ruedas
            ctx.fillStyle = '#2C2C2C';
            ctx.beginPath();
            ctx.arc(player.x - 15, player.y + 55, 10, 0, Math.PI * 2);
            ctx.arc(player.x + 15, player.y + 55, 10, 0, Math.PI * 2);
            ctx.fill();
            
            // Llantas
            ctx.fillStyle = '#C0C0C0';
            ctx.beginPath();
            ctx.arc(player.x - 15, player.y + 55, 6, 0, Math.PI * 2);
            ctx.arc(player.x + 15, player.y + 55, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Asiento
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(player.x - 15, player.y + 15, 30, 12);
            
            // Conductor
            ctx.fillStyle = '#FF4444';
            ctx.fillRect(player.x - 6, player.y - 5, 12, 25);
            
            // Cabeza del conductor
            ctx.fillStyle = '#FFE4C4';
            ctx.beginPath();
            ctx.arc(player.x, player.y - 10, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Luis Espert (pasajero)
            // Traje
            ctx.fillStyle = '#2C3E50';
            ctx.fillRect(player.x - 8, player.y + 8, 16, 25);
            
            // Cabeza pelada caracter√≠stica
            ctx.fillStyle = '#FFE4C4';
            ctx.beginPath();
            ctx.arc(player.x, player.y + 2, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Brillo en la cabeza
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.arc(player.x - 2, player.y - 1, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Camisa blanca
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(player.x - 6, player.y + 13, 12, 8);
            
            // Corbata
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(player.x - 2, player.y + 16, 4, 12);
            
            // Brazos
            ctx.fillStyle = '#2C3E50';
            ctx.fillRect(player.x - 12, player.y + 15, 6, 8);
            ctx.fillRect(player.x + 6, player.y + 15, 6, 8);
            
            // Manos
            ctx.fillStyle = '#FFE4C4';
            ctx.beginPath();
            ctx.arc(player.x - 9, player.y + 12, 3, 0, Math.PI * 2);
            ctx.arc(player.x + 9, player.y + 12, 3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }
        
        // Crear vegetales
        function createVegetable() {
            if (Math.random() < 0.02 + (60 - timeLeft) * 0.001) {
                const vegetableTypes = ['ü•¨', 'ü•ï', 'üßÖ', 'üçÖ', 'ü•î', 'üå∂Ô∏è', 'ü•í', 'ü•¶'];
                vegetables.push({
                    x: canvas.width / 2 - 140 + Math.random() * 280,
                    y: -30,
                    dx: (Math.random() - 0.5) * 2,
                    dy: gameSpeed + Math.random() * 3 + 1,
                    type: vegetableTypes[Math.floor(Math.random() * vegetableTypes.length)],
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: (Math.random() - 0.5) * 0.2,
                    size: 18 + Math.random() * 8
                });
            }
        }
        
        // Dibujar vegetales
        function drawVegetables() {
            vegetables.forEach(veg => {
                ctx.save();
                ctx.translate(veg.x + veg.size/2, veg.y + veg.size/2);
                ctx.rotate(veg.rotation);
                ctx.font = `${veg.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Sombra
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillText(veg.type, 2, 2);
                
                // Vegetal
                ctx.fillStyle = '#000';
                ctx.fillText(veg.type, 0, 0);
                
                ctx.restore();
            });
        }
        
        // Actualizar vegetales
        function updateVegetables() {
            for (let i = vegetables.length - 1; i >= 0; i--) {
                const veg = vegetables[i];
                veg.x += veg.dx;
                veg.y += veg.dy;
                veg.rotation += veg.rotationSpeed;
                
                // Eliminar vegetales fuera de pantalla
                if (veg.y > canvas.height + 50) {
                    vegetables.splice(i, 1);
                    score += 5;
                }
            }
        }
        
        // Detectar colisiones
        function checkCollisions() {
            for (let i = vegetables.length - 1; i >= 0; i--) {
                const veg = vegetables[i];
                
                // Colisi√≥n simple con rect√°ngulos
                if (veg.x < player.x + player.width - 10 &&
                    veg.x + veg.size > player.x + 10 &&
                    veg.y < player.y + player.height - 10 &&
                    veg.y + veg.size > player.y + 10) {
                    
                    vegetables.splice(i, 1);
                    lives--;
                    
                    // Efecto visual de impacto
                    player.x += (Math.random() - 0.5) * 10;
                    
                    // Sonido de impacto
                    playSound(150, 0.3);
                    
                    if (lives <= 0) {
                        gameState = 'gameOver';
                    }
                }
            }
        }
        
        // Actualizar elementos del fondo
        function updateBackground() {
            // Mover l√≠neas de carretera
            roadLines.forEach(line => {
                line.y += gameSpeed * 1.5;
                if (line.y > canvas.height) {
                    line.y = -line.height;
                }
            });
            
            // Mover edificios
            buildings.forEach(building => {
                building.y += gameSpeed * 0.6;
                if (building.y > canvas.height) {
                    building.y = -building.height - Math.random() * 200;
                }
            });
            
            // Mover nubes
            clouds.forEach(cloud => {
                cloud.y += gameSpeed * 0.3;
                if (cloud.y > canvas.height + cloud.size) {
                    cloud.y = -cloud.size * 2;
                    cloud.x = Math.random() * canvas.width;
                }
            });
        }
        
        // Actualizar jugador
        function updatePlayer() {
            const isMovingLeft = keys['ArrowLeft'] || keys['KeyA'] || mobileControls.left;
            const isMovingRight = keys['ArrowRight'] || keys['KeyD'] || mobileControls.right;
            
            if (isMovingLeft && player.x > canvas.width / 2 - 140) {
                player.dx = Math.max(player.dx - 0.8, -5);
            } else if (isMovingRight && player.x < canvas.width / 2 + 140 - player.width) {
                player.dx = Math.min(player.dx + 0.8, 5);
            } else {
                player.dx *= 0.85;
            }
            
            player.x += player.dx;
            
            // L√≠mites de la carretera
            if (player.x < canvas.width / 2 - 140) {
                player.x = canvas.width / 2 - 140;
                player.dx = 0;
            }
            if (player.x > canvas.width / 2 + 140 - player.width) {
                player.x = canvas.width / 2 + 140 - player.width;
                player.dx = 0;
            }
        }
        
        // Dibujar vecinos en las veredas
        function drawNeighbors() {
            const time = Date.now() * 0.001;
            
            // Vecinos lado izquierdo
            for (let i = 0; i < 4; i++) {
                let x = 60 + i * 40;
                let y = (100 + i * 120 + time * 50) % (canvas.height + 100);
                
                if (y > -50 && y < canvas.height + 50) {
                    // Cuerpo
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x, y, 12, 25);
                    
                    // Cabeza
                    ctx.fillStyle = '#FFE4C4';
                    ctx.beginPath();
                    ctx.arc(x + 6, y - 8, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Brazo lanzando
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(x + 12, y + 8);
                    ctx.lineTo(x + 25 + Math.sin(time * 3) * 5, y + 2);
                    ctx.stroke();
                }
            }
            
            // Vecinos lado derecho
            for (let i = 0; i < 4; i++) {
                let x = canvas.width - 80 - i * 40;
                let y = (120 + i * 100 + time * 45) % (canvas.height + 100);
                
                if (y > -50 && y < canvas.height + 50) {
                    // Cuerpo
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x, y, 12, 25);
                    
                    // Cabeza
                    ctx.fillStyle = '#FFE4C4';
                    ctx.beginPath();
                    ctx.arc(x + 6, y - 8, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Brazo lanzando
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(x, y + 8);
                    ctx.lineTo(x - 15 - Math.sin(time * 3) * 5, y + 2);
                    ctx.stroke();
                }
            }
        }
        
        // Loop principal del juego
        function gameLoop() {
            if (gameState === 'playing') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                updateBackground();
                updatePlayer();
                createVegetable();
                updateVegetables();
                checkCollisions();
                
                drawBackground();
                drawNeighbors();
                drawPlayer();
                drawVegetables();
                
                // Aumentar velocidad gradualmente
                gameSpeed = Math.min(2 + (60 - timeLeft) * 0.06, 6);
                
                // Actualizar UI
                document.getElementById('timer').textContent = timeLeft;
                document.getElementById('lives').textContent = lives;
                document.getElementById('score').textContent = score;
                
                // Verificar condici√≥n de victoria
                if (timeLeft <= 0) {
                    gameState = 'win';
                    playSound(600, 1.0);
                    setTimeout(() => playSound(800, 0.8), 200);
                    setTimeout(() => playSound(1000, 1.2), 400);
                }
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Timer del juego
        let gameTimer = null;
        
        function startTimer() {
            gameTimer = setInterval(() => {
                if (gameState === 'playing' && timeLeft > 0) {
                    timeLeft--;
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }
        
        // Controles de teclado
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            
            // Inicializar audio en primera interacci√≥n
            if (!audioContext) {
                initAudioContext();
            }
            
            // Prevenir scroll con flechas
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.code)) {
                e.preventDefault();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
        
        // Funciones de control del juego
        function startGame() {
            gameState = 'playing';
            timeLeft = 60;
            lives = 5;
            score = 0;
            vegetables = [];
            player.x = canvas.width / 2;
            player.dx = 0;
            gameSpeed = 2;
            
            // Cargar y reproducir m√∫sica desde el segundo 40
            console.log('üéÆ Iniciando juego - Cargando m√∫sica...');
            loadGameMusic();
            
            // Dar un momento para que la m√∫sica se cargue antes de reproducir
            setTimeout(() => {
                playBackgroundMusic();
            }, 500);
            
            // Inicializar audio y empezar timer
            initAudioContext();
            startTimer();
            
            // Ocultar pantallas
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('winScreen').classList.add('hidden');
        }
        
        function restartGame() {
            gameState = 'start';
            stopTimer();
            stopBackgroundMusic();
            
            // Mostrar pantalla de inicio
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('winScreen').classList.add('hidden');
            
            // Reinicializar elementos
            initBackground();
            
            console.log('üîÑ Juego reiniciado - Listo para nueva partida');
        }
        
        // Observar cambios de estado del juego
        let gameStateChecker = setInterval(() => {
            if (gameState === 'gameOver') {
                document.getElementById('finalScore').textContent = score;
                document.getElementById('gameOverScreen').classList.remove('hidden');
                stopTimer();
                stopBackgroundMusic();
                
                // Sonido de game over
                playSound(100, 0.5);
                setTimeout(() => playSound(80, 0.8), 300);
                
            } else if (gameState === 'win') {
                document.getElementById('winScore').textContent = score;
                document.getElementById('winScreen').classList.remove('hidden');
                stopTimer();
                stopBackgroundMusic();
                
                // Animar helic√≥ptero
                const helicopter = document.getElementById('helicopter');
                helicopter.style.display = 'block';
                
                let helicopterAnimation = setInterval(() => {
                    if (gameState !== 'win') {
                        clearInterval(helicopterAnimation);
                        return;
                    }
                    
                    const time = Date.now() * 0.003;
                    helicopter.style.top = (200 + Math.sin(time) * 15) + 'px';
                    helicopter.style.left = (300 + Math.cos(time * 0.7) * 30) + 'px';
                }, 50);
            }
        }, 100);
        
        // Sistema de sonidos mejorado
        function playSound(frequency, duration, type = 'square') {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Error reproduciendo sonido:', e);
            }
        }
        
        // Efectos de part√≠culas simples
        let particles = [];
        
        function createParticle(x, y, color) {
            particles.push({
                x: x,
                y: y,
                dx: (Math.random() - 0.5) * 4,
                dy: -Math.random() * 3 - 1,
                life: 1,
                color: color
            });
        }
        
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.x += particle.dx;
                particle.y += particle.dy;
                particle.life -= 0.02;
                
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
        function drawParticles() {
            particles.forEach(particle => {
                ctx.save();
                ctx.globalAlpha = particle.life;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }
        
        // Inicializar juego
        initBackground();
        setupMobileControls();
        gameLoop();
        
        // Pre-cargar la m√∫sica al inicializar
        console.log('üéµ Pre-cargando m√∫sica del juego...');
        loadGameMusic();
        
        // Prevenir comportamientos no deseados en m√≥viles
        document.addEventListener('touchstart', (e) => {
            // Inicializar audio en primera interacci√≥n t√°ctil
            if (!audioContext) {
                initAudioContext();
            }
            
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });
        
        // Prevenir scroll del documento
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('#gameContainer')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Manejar cambios de orientaci√≥n
        window.addEventListener('orientationchange', () => {
            setTimeout(resizeCanvas, 100);
        });
        
        // Manejar visibilidad de la p√°gina
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && gameState === 'playing') {
                // Pausar el juego cuando la pesta√±a no est√° visible
                gameState = 'paused';
            }
        });
        
        // Funci√≥n para reanudar el juego
        function resumeGame() {
            if (gameState === 'paused') {
                gameState = 'playing';
                playBackgroundMusic(); // Reanudar m√∫sica desde el segundo 40
            }
        }
        
        // Reanudar al hacer click en el canvas
        canvas.addEventListener('click', resumeGame);
        
        // Debug: mostrar informaci√≥n en consola
        console.log('üèçÔ∏è Escape de Lomas - Juego inicializado');
        console.log('Controles: Flechas del teclado o botones t√°ctiles');
        console.log('Objetivo: Sobrevivir 60 segundos esquivando verduras');
        
        // Easter egg: Konami code
        let konamiCode = [];
        const konami = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight'];
        
        document.addEventListener('keydown', (e) => {
            konamiCode.push(e.code);
            if (konamiCode.length > konami.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.join(',') === konami.join(',')) {
                // Modo invencible
                lives = 999;
                playSound(1000, 0.5);
                console.log('üéÆ ¬°C√≥digo Konami activado! Modo invencible');
                konamiCode = [];
            }
        });
        
        // Funci√≥n para pantalla completa (opcional)
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.log('Error al activar pantalla completa:', e);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Doble toque para pantalla completa en m√≥viles
        let lastTouchTime = 0;
        canvas.addEventListener('touchend', (e) => {
            const currentTime = Date.now();
            if (currentTime - lastTouchTime < 300) {
                toggleFullscreen();
            }
            lastTouchTime = currentTime;
        });
    </script>
</body>
</html>
